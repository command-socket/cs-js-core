"use strict";var __awaiter=this&&this.__awaiter||function(e,t,s,o){return new(s||(s=Promise))((function(r,n){function i(e){try{m(o.next(e))}catch(e){n(e)}}function a(e){try{m(o.throw(e))}catch(e){n(e)}}function m(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(i,a)}m((o=o.apply(e,t||[])).next())}))},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(exports,"__esModule",{value:!0});const typit_1=require("typit"),IDUtilities=__importStar(require("../util/id-utilities")),command_registry_1=require("../command/command-registry"),message_definition_1=require("../schema/typing/message-definition"),command_socket_message_factory_1=require("../schema/message/command-socket-message-factory"),command_socket_error_1=require("../error/command-socket-error"),command_socket_command_not_found_error_1=require("../error/command-socket-command-not-found-error"),command_socket_server_error_1=require("../error/command-socket-server-error"),command_socket_misplaced_response_error_1=require("../error/command-socket-misplaced-response-error"),identify_command_1=require("../builtin/commands/identify-command"),ping_command_1=require("../builtin/commands/ping-command"),command_socket_events_1=require("./command-socket-events"),command_socket_state_1=require("./command-socket-state"),timed_response_command_1=require("../builtin/commands/debug/timed-response-command"),command_socket_unrequited_request_error_1=require("../error/command-socket-unrequited-request-error");class CommandSocket{constructor(e,t=new command_registry_1.CommandRegistry){this.id=IDUtilities.generateID(CommandSocket.ID_LENGTH),this.socket=e,this.state=command_socket_state_1.CommandSocketState.CONNECTING,this.commandRegistry=t,this.messageType=new typit_1.ObjectType(new message_definition_1.MessageDefinition),this.outstandingRequests=new Map,this.events=new command_socket_events_1.CommandSocketEvents,this.socket.getEvents().OPEN.subscribe(e=>{this.state=command_socket_state_1.CommandSocketState.OPEN,this.getEvents().OPEN.notify({source:this})}),this.socket.getEvents().MESSAGE.subscribe(e=>{this.handleMessage(e.data)}),this.socket.getEvents().CLOSE.subscribe(e=>{this.state=command_socket_state_1.CommandSocketState.CLOSED,this.getEvents().CLOSE.notify(Object.assign(Object.assign({},e),{source:this}))}),this.commandRegistry.addCommands(...CommandSocket.BUILTIN_COMMANDS)}rawRequest(e,t){return __awaiter(this,void 0,void 0,(function*(){return new Promise((s,o)=>__awaiter(this,void 0,void 0,(function*(){this.getState().isUsable()||o("Cannot perform a request on a non-open CommandSocket.");let r=yield command_socket_message_factory_1.CommandSocketMessageFactory.createRequestMessage(e,void 0===t?null:t,this);this.outstandingRequests.set(r.meta.correspondenceID,{request:r,responseCallback:(e,t)=>{e.meta.timeline.responseReceived=t,this.getEvents().REQUEST_FULFILLED.notify({source:this,request:r,response:e}),this.outstandingRequests.delete(r.meta.correspondenceID),s(e)}}),this.getEvents().OUTGOING_REQUEST.notify({source:this,request:r}),this.socket.send(JSON.stringify(r))})))}))}invoke(e,t){return __awaiter(this,void 0,void 0,(function*(){let s=yield this.rawRequest(e,t);if(s.meta.didError)throw s.return;return s.return}))}ping(){return __awaiter(this,void 0,void 0,(function*(){let e=yield this.rawRequest("commandsocket ping","Ping!");return e.meta.timeline.responseReceived-e.meta.timeline.requestSent}))}close(){return __awaiter(this,void 0,void 0,(function*(){let e=Date.now();for(let t of this.outstandingRequests.values()){let s=yield command_socket_message_factory_1.CommandSocketMessageFactory.createResponseMessage(t.request,new command_socket_unrequited_request_error_1.CommandSocketUnrequitedRequestError,this,!0,e);t.responseCallback(s,e)}this.outstandingRequests.clear(),this.socket.close()}))}handleMessage(e){let t,s=Date.now();try{if(t=JSON.parse(e),!this.messageType.checkConformity(t))throw new Error("MalformedMessageError");let o=t;"request"===o.meta.mode?this.handleRequest(o,s):this.handleResponse(o,s)}catch(e){throw new Error("MalformedMessageError")}}handleRequest(e,t){return __awaiter(this,void 0,void 0,(function*(){let s;this.getEvents().INCOMING_REQUEST.notify({source:this,request:e});try{if(this.getCommandRegistry().hasCommand(e.command)){let o=yield this.getCommandRegistry().execute(e.command,e.parameters,this);s=yield command_socket_message_factory_1.CommandSocketMessageFactory.createResponseMessage(e,o,this,!1,t)}else s=yield new command_socket_command_not_found_error_1.CommandSocketCommandNotFoundError(e.command).toMessage(e,this)}catch(t){s=t instanceof command_socket_error_1.CommandSocketError?yield t.toMessage(e,this):yield(new command_socket_server_error_1.CommandSocketServerError).toMessage(e,this)}this.getEvents().OUTGOING_RESPONSE.notify({source:this,request:e,response:s}),this.socket.send(JSON.stringify(s))}))}handleResponse(e,t){if(this.outstandingRequests.has(e.meta.correspondenceID)){let s=this.outstandingRequests.get(e.meta.correspondenceID);this.outstandingRequests.delete(e.meta.correspondenceID),this.getEvents().INCOMING_RESPONSE.notify({source:this,request:s.request,response:e}),s.responseCallback(e,t)}else console.error(new command_socket_misplaced_response_error_1.CommandSocketMisplacedResponseError)}getID(){return this.id}getCommandRegistry(){return this.commandRegistry}getSocketIdentity(){return __awaiter(this,void 0,void 0,(function*(){return{id:this.getID(),ip:yield this.socket.getIP()}}))}getState(){return this.state}getEvents(){return this.events}}exports.CommandSocket=CommandSocket,CommandSocket.ID_LENGTH=10,CommandSocket.BUILTIN_COMMANDS=[new identify_command_1.IdentifyCommand,new ping_command_1.PingCommand,new timed_response_command_1.TimedResponseCommand];
//# sourceMappingURL=command-socket.js.map
